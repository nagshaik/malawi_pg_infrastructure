apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit
  namespace: logging
  labels:
    app.kubernetes.io/instance: fluent-bit
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: fluent-bit
    app.kubernetes.io/version: 4.1.0
    helm.sh/chart: fluent-bit-0.53.0

data:
  # Helm charts usually mount a key named 'parsers.conf'.
  # Keep 'custom_parsers.conf' for reference and add 'parsers.conf' with the same content
  # so the Pod's volume items can find the expected key.
  custom_parsers.conf: |
    [PARSER]
        Name        docker_new
        Format      regex
        Regex       ^.*\s+stdout\s+F\s+(?<log>.*)$
        Decode_Field json log
        Time_Keep   On
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L

  parsers.conf: |
    [PARSER]
        Name        docker_new
        Format      regex
        Regex       ^.*\s+stdout\s+F\s+(?<log>.*)$
        Decode_Field json log
        Time_Keep   On
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L

  fluent-bit.conf: |
    [SERVICE]
        Flush                1
        Log_Level            info
        Parsers_File         /fluent-bit/etc/conf/parsers.conf
        HTTP_Server          On
        HTTP_Listen          0.0.0.0
        HTTP_Port            2020
        Health_Check         On

    [INPUT]
        Name              tail
        Path              /var/log/containers/*.log
        Tag               kube.*
        Mem_Buf_Limit     5MB
        Skip_Long_Lines   On
        Refresh_Interval  5

    [FILTER]
        Name                  kubernetes
        Match                 kube.*
        Merge_Log             On
        Keep_Log              Off
        K8S-Logging.Parser    On
        K8S-Logging.Exclude   On

    [FILTER]
        Name                parser
        Match               *
        Parser              docker_new
        Key_Name            log
        Preserve_Key        False
        Reserve_Data        On

    [OUTPUT]
        Name                es
        Match               kube.*
        Host                vpc-malawi-pg-elk-cluster-s5fqgvti5w3popzer6dv5ziz5m.eu-central-1.es.amazonaws.com
        Port                443
        Logstash_Format     On
        Logstash_Prefix     new_cluster_logs
        Logstash_DateFormat %Y.%m.%d
        HTTP_User           admin
        HTTP_Passwd         MalawiELK2025!Secure#
        Replace_Dots        On
        tls                 On
        tls.verify          Off
        Retry_Limit         3
        Suppress_Type_Name  On
        Workers             2
        Buffer_Size         512KB

    #[OUTPUT]
    #    Name  stdout
    #    Match kube.*

    #[STORAGE]
    #    storage.type        filesystem
    #    storage.sync        normal
    #    storage.path        /var/fluent-bit/state
    #    storage.max_chunks_up 256


